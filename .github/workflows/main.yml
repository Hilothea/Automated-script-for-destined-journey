name: Build and Release Merged Script

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  OUTPUT_FILE: "automated-script-for-destined-journey.js"
  JSON_FILE: "automated-script-for-destined-journey.json"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.commit.outputs.changed }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Combine scripts
      run: |
        set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º
        
        # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„æ–‡ä»¶å
        output_file="${OUTPUT_FILE}"
        
        echo "å¼€å§‹åˆå¹¶è„šæœ¬æ–‡ä»¶..."
        echo "è¾“å‡ºæ–‡ä»¶: $output_file"
        
        # å®šä¹‰è¦åˆå¹¶çš„è„šæœ¬æ–‡ä»¶é¡ºåº
        files=(
            "config.js"
            "utils.js"
            "experience-level.js"
            "currency-system.js"
            "info-injection.js"
            "event-chain-system.js"
            "main-controller.js"
        )
        
        # æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        for file in "${files[@]}"; do
            if [[ ! -f "$file" ]]; then
                echo "é”™è¯¯: æ–‡ä»¶ $file ä¸å­˜åœ¨"
                exit 1
            fi
            echo "âœ“ æ‰¾åˆ°æ–‡ä»¶: $file"
        done
        
        # æ¸…ç©ºæˆ–åˆ›å»ºè¾“å‡ºæ–‡ä»¶
        > "$output_file"
        
        # æ·»åŠ æ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
        echo "// ================================================================" >> "$output_file"
        echo "// å‘½å®šä¹‹è¯—ä¸é»„æ˜ä¹‹æ­Œè‡ªåŠ¨åŒ–è„šæœ¬ - è‡ªåŠ¨åˆå¹¶ç‰ˆæœ¬" >> "$output_file"
        echo "// æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$output_file"
        echo "// åŒ…å«æ¨¡å—: ${files[*]}" >> "$output_file"
        echo "// ================================================================" >> "$output_file"
        echo "" >> "$output_file"
        
        # å¾ªç¯éå†æ–‡ä»¶æ•°ç»„å¹¶å°†å®ƒä»¬çš„å†…å®¹è¿½åŠ åˆ°è¾“å‡ºæ–‡ä»¶
        for file in "${files[@]}"; do
            echo "æ­£åœ¨åˆå¹¶: $file"
            echo "// ======================== [Module: ${file}] ========================" >> "$output_file"
            cat "$file" >> "$output_file"
            echo "" >> "$output_file"
            echo "" >> "$output_file"
        done
        
        echo "âœ“ è„šæœ¬åˆå¹¶å®Œæˆï¼"
        echo "è¾“å‡ºæ–‡ä»¶å¤§å°: $(wc -c < "$output_file") å­—èŠ‚"
    - name: Generate JSON file
      run: |
        echo "å¼€å§‹ç”ŸæˆJSONæ–‡ä»¶..."
        
        # ä½¿ç”¨ Node.js è„šæœ¬æ¥åˆ›å»º JSON æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°å¤„ç†ç‰¹æ®Šå­—ç¬¦å’Œæ ¼å¼
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        try {
          console.log('æ­£åœ¨è¯»å–æ–‡ä»¶...');
          
          // ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„æ–‡ä»¶å
          const outputFile = process.env.OUTPUT_FILE;
          const jsonFile = process.env.JSON_FILE;
          
          // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (!fs.existsSync(outputFile)) {
            throw new Error(`åˆå¹¶è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: ${outputFile}`);
          }
          
          if (!fs.existsSync('README.md')) {
            throw new Error('README.md æ–‡ä»¶ä¸å­˜åœ¨');
          }
          
          // è¯»å–è„šæœ¬å’Œ README æ–‡ä»¶çš„å†…å®¹
          console.log(`è¯»å–è„šæœ¬æ–‡ä»¶: ${outputFile}`);
          const scriptContent = fs.readFileSync(outputFile, 'utf8');
          
          console.log('è¯»å–READMEæ–‡ä»¶...');
          const readmeContent = fs.readFileSync('README.md', 'utf8');
          
          // æ„å»º JSON å¯¹è±¡
          const jsonObject = {
            id: "03310a07-7f00-4aa9-8ad5-2259a88767f6",
            name: "å‘½å®šä¹‹è¯—ä¸é»„æ˜ä¹‹æ­Œè‡ªåŠ¨åŒ–è„šæœ¬",
            content: scriptContent,
            info: readmeContent,
            buttons: [],
            data: {}
          };
          
          // å°† JSON å¯¹è±¡å†™å…¥æ–‡ä»¶
          console.log(`å†™å…¥JSONæ–‡ä»¶: ${jsonFile}`);
          fs.writeFileSync(jsonFile, JSON.stringify(jsonObject, null, 2), 'utf8');
          
          // è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
          const stats = fs.statSync(jsonFile);
          console.log(`âœ“ JSONæ–‡ä»¶åˆ›å»ºæˆåŠŸï¼`);
          console.log(`æ–‡ä»¶å¤§å°: ${stats.size} å­—èŠ‚`);
          
        } catch (error) {
          console.error('ç”ŸæˆJSONæ–‡ä»¶æ—¶å‡ºé”™:', error.message);
          process.exit(1);
        }
        EOF
        
        echo "âœ“ JSONæ–‡ä»¶ç”Ÿæˆå®Œæˆï¼"
    - name: Commit and push if changed
      id: commit
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --local user.name "github-actions[bot]"
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        
        # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„æ–‡ä»¶å
        output_file="${OUTPUT_FILE}"
        json_file="${JSON_FILE}"
        
        echo "å¾…æäº¤æ–‡ä»¶:"
        echo "- $output_file"
        echo "- $json_file"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [[ ! -f "$output_file" ]]; then
          echo "é”™è¯¯: è¾“å‡ºæ–‡ä»¶ $output_file ä¸å­˜åœ¨"
          exit 1
        fi
        
        if [[ ! -f "$json_file" ]]; then
          echo "é”™è¯¯: JSONæ–‡ä»¶ $json_file ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ·»åŠ æ–‡ä»¶åˆ°Git
        git add "$output_file" "$json_file"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "âœ“ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "âœ“ å‘ç°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤"
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          git diff --staged --stat
          
          # æäº¤å˜æ›´
          commit_message="ci: è‡ªåŠ¨æ„å»º - æ›´æ–°åˆå¹¶è„šæœ¬å’ŒJSONæ–‡ä»¶
          
          - æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - æäº¤å“ˆå¸Œ: ${GITHUB_SHA:0:7}
          - è§¦å‘åˆ†æ”¯: ${GITHUB_REF#refs/heads/}"
          
          git commit -m "$commit_message"
          git push
          
          echo "âœ“ æ–‡ä»¶å·²æˆåŠŸæäº¤å¹¶æ¨é€"
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: merged-script-artifact
        path: |
          ${{ env.OUTPUT_FILE }}
          ${{ env.JSON_FILE }}

  release:
    needs: build
    if: needs.build.outputs.changed == 'true'
    runs-on: ubuntu-latest
    env:
      OUTPUT_FILE: "automated-script-for-destined-journey.js"
      JSON_FILE: "automated-script-for-destined-journey.json"
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: merged-script-artifact
        
    - name: Get next version
      id: tag_version
      uses: mathieudutour/github-tag-action@v6.2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag_version.outputs.new_tag }}
        name: "Release ${{ steps.tag_version.outputs.new_tag }}"
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ
          
          è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨æ„å»ºçš„å‘å¸ƒç‰ˆæœ¬ï¼ŒåŒ…å«åˆå¹¶åçš„è„šæœ¬å’ŒJSONé…ç½®æ–‡ä»¶ã€‚
          
          ### ğŸ“¦ å‘å¸ƒå†…å®¹
          - **åˆå¹¶è„šæœ¬**: `${{ env.OUTPUT_FILE }}`
          - **JSONé…ç½®**: `${{ env.JSON_FILE }}`
          
          ### â° æ„å»ºä¿¡æ¯
          - **å‘å¸ƒæ—¶é—´**: ${{ steps.tag_version.outputs.new_tag }}
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **è§¦å‘åˆ†æ”¯**: ${{ github.ref_name }}
          
          ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
          ä¸‹è½½é™„ä»¶ä¸­çš„æ–‡ä»¶å³å¯ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„è‡ªåŠ¨åŒ–è„šæœ¬ã€‚
        files: |
          ${{ env.OUTPUT_FILE }}
          ${{ env.JSON_FILE }}
